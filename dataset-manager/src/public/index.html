<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WeaveUI Dataset Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet" />
    <style>
      body { font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
      .container { margin-top: 24px; }
      .card-title { font-weight: 600; }
    </style>
  </head>
  <body class="blue-grey lighten-5">
    <nav class="blue darken-2" role="navigation" aria-label="Main">
      <div class="nav-wrapper container">
        <a class="brand-logo" href="#">WeaveUI</a>
        <ul id="nav-mobile" class="right">
          <li><a href="/oauth/start">Connect Dribbble</a></li>
        </ul>
      </div>
    </nav>
    <main class="container" id="main">
      <h5>Consent Requests</h5>
      <div class="card">
        <div class="card-content">
          <span class="card-title">Prepare Email</span>
          <div class="row">
            <form class="col s12" id="consentForm">
              <div class="row">
                <div class="input-field col s4">
                  <input id="id" name="id" type="text" required aria-required="true" />
                  <label for="id">Entry ID</label>
                </div>
                <div class="input-field col s8">
                  <input id="creator" name="creator" type="text" required aria-required="true" />
                  <label for="creator">Creator name</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input id="title" name="title" type="text" required aria-required="true" />
                  <label for="title">Shot title</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input id="url" name="url" type="url" required aria-required="true" />
                  <label for="url">Shot URL</label>
                </div>
              </div>
              <button class="btn waves-effect waves-light" type="submit">Generate Email</button>
            </form>
          </div>
          <pre id="result" style="white-space: pre-wrap"></pre>
        </div>
      </div>

      <h5>Dashboard</h5>
      <div class="card">
        <div class="card-content">
          <span class="card-title">Status & Actions</span>
          <div class="row" style="margin-bottom: 0">
            <div class="input-field col s4">
              <input id="dashId" type="text" aria-label="Entry ID (same as above)" />
              <label for="dashId">Entry ID (defaults to form ID)</label>
            </div>
            <div class="input-field col s8">
              <input id="evidence" type="text" aria-label="Consent evidence path (optional)" />
              <label for="evidence">Consent evidence path (optional)</label>
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <div class="col s12">
              <button id="btnStatus" class="btn-flat waves-effect">Check Status</button>
              <button id="btnMarkSent" class="btn waves-effect teal" style="margin-left: 8px">Mark Sent</button>
              <button id="btnMarkConsent" class="btn waves-effect indigo" style="margin-left: 8px">Mark Consent</button>
              <button id="btnDownload" class="btn waves-effect deep-purple" style="margin-left: 8px">Download Shots</button>
            </div>
          </div>
          <pre id="statusResult" style="white-space: pre-wrap"></pre>
        </div>
      </div>
    </main>
    <script>
      document.getElementById('consentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const params = new URLSearchParams(new FormData(e.target));
        const r = await fetch(`/consent/prepare?${params.toString()}`);
        const data = await r.json();
        const result = document.getElementById('result');
        if (data.ok) {
          result.textContent = `Saved consent-request.txt â†’ ${data.saved}`;
        } else {
          result.textContent = `Error: ${data.error || 'unknown'}`;
        }
      });

      function getId() {
        const dash = document.getElementById('dashId').value.trim();
        if (dash) return dash;
        return document.getElementById('id').value.trim();
      }

      async function checkStatus() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const r = await fetch(`/dashboard/status?id=${encodeURIComponent(id)}`);
        const data = await r.json();
        document.getElementById('statusResult').textContent = JSON.stringify(data, null, 2);
      }

      async function markSent() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const title = document.getElementById('title').value.trim();
        const url = document.getElementById('url').value.trim();
        const creator = document.getElementById('creator').value.trim();
        const q = new URLSearchParams({ id, title, url, creator });
        const r = await fetch(`/dashboard/mark-sent?${q.toString()}`, { method: 'POST' });
        const data = await r.json();
        if (!data.ok) return M.toast({html: 'Mark sent failed'});
        await checkStatus();
      }

      async function markConsent() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const evidence = document.getElementById('evidence').value.trim();
        const q = new URLSearchParams({ id, evidence });
        const r = await fetch(`/dashboard/mark-consent?${q.toString()}`, { method: 'POST' });
        const data = await r.json();
        if (!data.ok) return M.toast({html: 'Mark consent failed'});
        await checkStatus();
      }

      async function downloadShots() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const r = await fetch(`/dashboard/download?id=${encodeURIComponent(id)}`, { method: 'POST' });
        const data = await r.json();
        if (!data.ok) return M.toast({html: data.error || 'Download failed'});
        M.toast({html: `Saved ${data.saved} shots`});
        await checkStatus();
      }

      document.getElementById('btnStatus').addEventListener('click', checkStatus);
      document.getElementById('btnMarkSent').addEventListener('click', markSent);
      document.getElementById('btnMarkConsent').addEventListener('click', markConsent);
      document.getElementById('btnDownload').addEventListener('click', downloadShots);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  </body>
  </html>


