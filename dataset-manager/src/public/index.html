<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WeaveUI Dataset Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet" />
    <style>
      body { font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif; }
      .container { margin-top: 24px; }
      .card-title { font-weight: 600; }
    </style>
  </head>
  <body class="blue-grey lighten-5">
    <nav class="blue darken-2" role="navigation" aria-label="Main">
      <div class="nav-wrapper container">
        <a class="brand-logo" href="#">WeaveUI</a>
        <ul id="nav-mobile" class="right">
          <li><a id="connectBtn" href="/oauth/start">Connect Dribbble</a></li>
        </ul>
      </div>
    </nav>
    <main class="container" id="main" aria-live="polite">
      <div id="tokenWarn" class="card-panel yellow darken-2 black-text" style="display:none" role="status" aria-atomic="true">
        Dribbble access token not set. Downloads are disabled.
      </div>
      <div class="row" style="margin-bottom: 0">
        <div class="col s12 m6">
      <h5>Consent Requests</h5>
      <div class="card z-depth-1">
        <div class="card-content">
          <span class="card-title">Prepare Email</span>
          <div class="row">
            <form class="col s12" id="consentForm">
              <div class="row">
                <div class="input-field col s4">
                  <input id="id" name="id" type="text" required aria-required="true" />
                  <label for="id">Entry ID</label>
                  <span class="helper-text">Example: 001 (short, unique)</span>
                </div>
                <div class="input-field col s8">
                  <input id="creator" name="creator" type="text" required aria-required="true" />
                  <label for="creator">Creator name</label>
                  <span class="helper-text">Designer’s display name</span>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input id="handle" name="handle" type="text" />
                  <label for="handle">Creator handle (optional)</label>
                  <span class="helper-text">E.g., @creator (used to associate token/entry)</span>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input id="title" name="title" type="text" required aria-required="true" />
                  <label for="title">Shot title</label>
                  <span class="helper-text">E.g., “Banking SaaS Landing”</span>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input id="url" name="url" type="url" required aria-required="true" />
                  <label for="url">Shot URL</label>
                  <span class="helper-text">Full Dribbble link, e.g., https://dribbble.com/shots/12345</span>
                </div>
              </div>
              <div class="row" style="margin-bottom:0">
                <div class="input-field col s12">
                  <input id="toEmail" name="toEmail" type="email" aria-required="true" />
                  <label for="toEmail">Creator email</label>
                  <span class="helper-text">We’ll send the consent request here</span>
                </div>
              </div>
              <button id="btnGenerate" class="btn waves-effect waves-light" type="submit" disabled>
                <span class="btn-text">Generate Email</span>
                <span class="preloader-wrapper small active" style="display:none"><div class="spinner-layer spinner-white-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div></span>
              </button>
              <button id="btnSendEmail" class="btn waves-effect green" type="button" style="margin-left:8px" disabled>
                Send Email
              </button>
            </form>
          </div>
          <pre id="result" style="white-space: pre-wrap"></pre>
        </div>
      </div>
        </div>
        <div class="col s12 m6">
      <h5>Dashboard</h5>
      <div class="card z-depth-2">
        <div class="card-content">
          <span class="card-title">Status & Actions</span>
          <div class="row" style="margin-bottom: 0">
            <div class="input-field col s4">
              <input id="dashId" type="text" aria-label="Entry ID (same as above)" readonly />
              <label for="dashId">Entry ID</label>
              <span class="helper-text">Prefilled from form <a href="#" id="editId" aria-label="Edit Entry ID">edit</a></span>
            </div>
            <div class="input-field col s8">
              <input id="evidence" type="text" aria-label="Consent evidence path (optional)" />
              <label for="evidence">Consent evidence path (optional)</label>
            </div>
          </div>
          <div class="row" style="margin-top: 8px">
            <div class="col s12">
              <button id="btnStatus" class="btn-flat waves-effect">Check Status</button>
              <button id="btnMarkSent" class="btn waves-effect teal" style="margin-left: 8px" disabled>Mark Sent</button>
              <button id="btnMarkConsent" class="btn waves-effect indigo" style="margin-left: 8px" disabled>Mark Consent</button>
              <button id="btnDownload" class="btn waves-effect deep-purple tooltipped" data-tooltip="Connect token to enable" style="margin-left: 8px" disabled>Download Shots</button>
              <a id="btnReconnect" class="btn waves-effect orange" style="margin-left: 8px; display:none" href="#">Reconnect Dribbble</a>
            </div>
          </div>
          <div class="divider" style="margin: 12px 0"></div>
          <div id="statusChips" style="margin-bottom: 8px"></div>
          <div class="row" style="margin-bottom: 8px">
            <div class="input-field col s6">
              <select id="tagFilter">
                <option value="" selected>All tags</option>
              </select>
              <label for="tagFilter">Filter by tag</label>
            </div>
          </div>
          <pre id="statusResult" style="white-space: pre-wrap; max-height: 180px; overflow:auto"></pre>
          <table id="shotsTable" class="striped responsive-table" style="display:none">
            <thead>
              <tr><th>Shot ID</th><th>Tags</th><th>Image URL</th><th>File</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
        </div>
      </div>
    </main>
    <script>
      function validateForm() {
        const id = document.getElementById('id').value.trim();
        const creator = document.getElementById('creator').value.trim();
        const title = document.getElementById('title').value.trim();
        const url = document.getElementById('url').value.trim();
        const toEmail = document.getElementById('toEmail').value.trim();
        const ok = !!id && !!creator && !!title && /^https?:\/\//.test(url);
        const mailOk = ok && /\S+@\S+\.\S+/.test(toEmail);
        document.getElementById('btnGenerate').disabled = !ok;
        document.getElementById('btnMarkSent').disabled = !ok;
        document.getElementById('btnSendEmail').disabled = !mailOk;
        return ok;
      }

      ['id','creator','title','url'].forEach(id => document.getElementById(id).addEventListener('input', validateForm));

      document.getElementById('consentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const params = new URLSearchParams(new FormData(e.target));
        const btn = document.getElementById('btnGenerate');
        btn.querySelector('.preloader-wrapper').style.display = 'inline-block';
        btn.querySelector('.btn-text').style.display = 'none';
        const r = await fetch(`/consent/prepare?${params.toString()}`);
        const data = await r.json();
        const result = document.getElementById('result');
        if (data.ok) {
          result.textContent = `Saved consent-request.txt → ${data.saved}`;
        } else {
          result.textContent = `Error: ${data.error || 'unknown'}`;
        }
        btn.querySelector('.preloader-wrapper').style.display = 'none';
        btn.querySelector('.btn-text').style.display = 'inline';
        // Enable Send if everything is filled and email looks valid
        validateForm();
      });

      function getId() {
        const dash = document.getElementById('dashId').value.trim();
        if (dash) return dash;
        return document.getElementById('id').value.trim();
      }

      async function checkStatus() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const r = await fetch(`/dashboard/status?id=${encodeURIComponent(id)}`);
        const data = await r.json();
        document.getElementById('statusResult').textContent = JSON.stringify(data, null, 2);
        const chips = document.getElementById('statusChips');
        chips.innerHTML = '';
        const s = data.status || {};
        if (s.sentAt) chips.innerHTML += `<span class="chip">Sent: ${new Date(s.sentAt).toLocaleString()}</span>`;
        if (s.consent) chips.innerHTML += `<span class="chip ${s.consent.granted?'green white-text':''}">Consent: ${s.consent.granted?'Granted':'No'}</span>`;
        if (s.downloaded && s.downloaded.shots) chips.innerHTML += `<span class="chip">Downloads: ${s.downloaded.shots}</span>`;

        // Token chip and reconnect
        const cfg = await fetch('/config?id=' + encodeURIComponent(id)).then(x=>x.json());
        if (cfg.hasToken) {
          chips.innerHTML += `<span class="chip blue white-text">Token: Connected</span>`;
          document.getElementById('btnReconnect').style.display='none';
          const btn = document.getElementById('btnDownload');
          btn.disabled = false; btn.removeAttribute('data-tooltip');
        } else {
          chips.innerHTML += `<span class="chip">Token: Not connected</span>`;
          const rec = document.getElementById('btnReconnect');
          rec.style.display='inline-block';
          rec.href = `/oauth/start?id=${encodeURIComponent(id)}`;
        }

        const table = document.getElementById('shotsTable');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';
        if (data.entry && data.entry.downloads && data.entry.downloads.length) {
          table.style.display = '';
          // Build tag index
          const tagCounts = {};
          for (const d of data.entry.downloads) {
            const tags = (d.tags || '').split(',').filter(Boolean);
            for (const t of tags) tagCounts[t] = (tagCounts[t]||0)+1;
          }
          // Populate filter select
          const sel = document.getElementById('tagFilter');
          const current = sel.value;
          sel.innerHTML = '<option value="" selected>All tags</option>' + Object.keys(tagCounts).sort().map(t=>`<option value="${t}">${t} (${tagCounts[t]})</option>`).join('');
          // Render rows
          const activeTag = current; // preserve choice if present
          for (const d of data.entry.downloads) {
            const tr = document.createElement('tr');
            const tags = d.tags || '';
            tr.dataset.tags = tags;
            tr.innerHTML = `<td>${d.shotId}</td><td>${tags}</td><td><a href="${d.imageUrl}" target="_blank" rel="noopener">link</a></td><td>${d.filePath||''}</td><td><button class="btn-flat" data-copy="${d.filePath||''}">Copy</button></td>`;
            tbody.appendChild(tr);
          }
          // Apply filter if previously selected
          function applyTagFilter() {
            const f = document.getElementById('tagFilter').value;
            tbody.querySelectorAll('tr').forEach(tr => {
              if (!f) tr.style.display = '';
              else tr.style.display = (tr.dataset.tags.split(',').includes(f)) ? '' : 'none';
            });
          }
          document.getElementById('tagFilter').addEventListener('change', applyTagFilter);
          if (activeTag) { document.getElementById('tagFilter').value = activeTag; applyTagFilter(); }
          tbody.querySelectorAll('button[data-copy]').forEach(btn => btn.addEventListener('click', () => {
            const t = btn.getAttribute('data-copy'); navigator.clipboard.writeText(t||''); M.toast({html:'Path copied'});
          }));
        } else {
          table.style.display = 'none';
        }
      }

      async function markSent() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const title = document.getElementById('title').value.trim();
        const url = document.getElementById('url').value.trim();
        const creator = document.getElementById('creator').value.trim();
        const handle = document.getElementById('handle').value.trim();
        const q = new URLSearchParams({ id, title, url, creator, handle });
        const r = await fetch(`/dashboard/mark-sent?${q.toString()}`, { method: 'POST' });
        const data = await r.json();
        if (!data.ok) return M.toast({html: 'Mark sent failed'});
        await checkStatus();
      }

      async function markConsent() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const evidence = document.getElementById('evidence').value.trim();
        const q = new URLSearchParams({ id, evidence });
        const r = await fetch(`/dashboard/mark-consent?${q.toString()}`, { method: 'POST' });
        const data = await r.json();
        if (!data.ok) return M.toast({html: 'Mark consent failed'});
        await checkStatus();
      }

      async function downloadShots() {
        const id = getId();
        if (!id) return M.toast({html: 'Missing Entry ID'});
        const r = await fetch(`/dashboard/download?id=${encodeURIComponent(id)}`, { method: 'POST' });
        const data = await r.json();
        if (!data.ok) return M.toast({html: data.error || 'Download failed'});
        M.toast({html: `Saved ${data.saved} shots`});
        await checkStatus();
      }

      document.getElementById('btnStatus').addEventListener('click', checkStatus);
      document.getElementById('btnMarkSent').addEventListener('click', markSent);
      document.getElementById('btnMarkConsent').addEventListener('click', markConsent);
      document.getElementById('btnDownload').addEventListener('click', downloadShots);
      document.getElementById('btnSendEmail').addEventListener('click', async () => {
        const id = getId();
        const to = document.getElementById('toEmail').value.trim();
        const title = document.getElementById('title').value.trim();
        const creator = document.getElementById('creator').value.trim();
        const url = document.getElementById('url').value.trim();
        if (!id || !to || !title || !creator || !/^https?:\/\//.test(url)) return M.toast({html: 'Fill all fields (id, creator, title, url, to)'});
        const q = new URLSearchParams({ id, to, title, creator, url });
        const r = await fetch(`/email/consent?${q.toString()}`, { method: 'POST' });
        const data = await r.json();
        if (data.ok) { M.toast({html: `Email sent (id ${data.messageId})`}); await checkStatus(); }
        else { M.toast({html: `Send failed: ${data.error||'unknown'}`}); }
      });

      // Prefill dashboard ID, token gate, init
      function syncDashId() {
        const v = document.getElementById('id').value.trim();
        const dash = document.getElementById('dashId');
        if (!dash.dataset.editing) dash.value = v;
      }
      document.getElementById('id').addEventListener('input', syncDashId);
      document.getElementById('editId').addEventListener('click', (e)=>{e.preventDefault(); const d=document.getElementById('dashId'); d.readOnly=false; d.dataset.editing='1'; d.focus();});
      validateForm(); syncDashId();
      function updateConnectLink() {
        const id = getId();
        const link = document.getElementById('connectBtn');
        link.href = `/oauth/start?id=${encodeURIComponent(id)}`;
      }
      document.getElementById('id').addEventListener('input', updateConnectLink);
      updateConnectLink();

      fetch('/config?id=' + encodeURIComponent(getId())).then(r=>r.json()).then(cfg=>{
        if (!cfg.hasToken) {
          document.getElementById('tokenWarn').style.display='block';
        } else {
          const btn = document.getElementById('btnDownload');
          btn.disabled = false; btn.removeAttribute('data-tooltip');
        }
      });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  </body>
  </html>


